<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="page-title">PDF Viewer - SFCDD</title>
    <!-- Favicon -->
    <!-- Modern browsers -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <!-- Fallback for older browsers -->
    <link rel="icon" type="image/png" href="/favicon.png" />
    <style>
      :root {
        --font-size-base: 1rem;
        --font-size-large: 1.25rem;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        overflow: hidden;
        background-color: #525659;
        font-size: var(--font-size-base);
      }

      .pdf-container {
        width: 100%;
        height: 100vh;
      }

      .pdf-frame {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      .error-message {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background-color: #f8f9fa;
        color: #721c24;
        font-size: var(--font-size-large);
        padding: 2rem;
        text-align: center;
      }

      .error-message a {
        font-size: var(--font-size-base);
      }
    </style>
  </head>
  <body>
    <div class="pdf-container">
      <iframe
        id="pdf-frame"
        class="pdf-frame"
        title="PDF Viewer"
        src=""
      ></iframe>
    </div>

    <script>
      // Detect if mobile device
      function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );
      }

      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const pdfParam = urlParams.get("pdf");
      const dataSource = urlParams.get("source"); // e.g., "plans" or "specs"
      const backUrl = urlParams.get("back") || "../index.html";

      // Load data to get drawing/document information
      async function loadDrawingInfo() {
        if (!pdfParam) {
          showError("No PDF specified");
          return;
        }

        if (!dataSource) {
          showError("No data source specified");
          return;
        }

        // Map source names to correct folder names
        const folderMap = {
          plans: "plan_pdfs",
          specs: "spec_pdfs",
          other: "other_pdfs",
        };

        const folderName = folderMap[dataSource] || dataSource;
        const pdfPath = `../standards/${folderName}/${pdfParam}.pdf`;

        // If mobile device, redirect directly to PDF
        if (isMobileDevice()) {
          window.location.href = pdfPath;
          return;
        }

        try {
          const response = await fetch(`../standards/${dataSource}.json`);
          const data = await response.json();

          // Find the drawing information
          let drawingInfo = null;

          // Handle different JSON structures
          if (data.categories) {
            // plans.json structure
            for (const category of data.categories) {
              for (const section of category.sections) {
                if (section.drawings) {
                  const found = section.drawings.find(
                    (d) => d.drawing_no === pdfParam
                  );
                  if (found) {
                    drawingInfo = found;
                    break;
                  }
                }
              }
              if (drawingInfo) break;
            }
          } else if (data.sections) {
            // specs.json or other.json structure
            const found = data.sections.find(
              (s) =>
                (s.file_name || s.section_number.replace(/ /g, "_")) ===
                pdfParam
            );
            if (found) {
              drawingInfo = {
                drawing_no: found.section_number,
                title: found.title,
              };
            }
          }

          if (drawingInfo) {
            // Update page title
            document.getElementById("page-title").textContent = `${
              drawingInfo.drawing_no
            } - ${drawingInfo.title.substring(0, 50)}${
              drawingInfo.title.length > 50 ? "..." : ""
            } - SFCDD`;

            // Set up PDF link
            document.getElementById("pdf-frame").src = pdfPath;
          } else {
            showError(
              `Document "${pdfParam}" not found in ${dataSource} database`
            );
          }
        } catch (error) {
          console.error("Error loading document info:", error);
          // Still show the PDF even if we can't load the metadata
          document.getElementById(
            "page-title"
          ).textContent = `${pdfParam} - SFCDD`;
          document.getElementById("pdf-frame").src = pdfPath;
        }
      }

      function showError(message) {
        document.querySelector(".pdf-container").innerHTML = `
          <div class="error-message">
            <div>
              <strong>Error:</strong> ${message}
              <br><br>
              <a href="${backUrl}" style="color: #017dc3; text-decoration: underline;">Go Back</a>
            </div>
          </div>
        `;
      }

      // Load drawing info on page load
      loadDrawingInfo();
    </script>
  </body>
</html>
